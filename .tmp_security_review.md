# Security Assessment - PR #1

## Executive Summary

**Status:** ‚ö†Ô∏è **CRITICAL ISSUES FOUND** - Immediate action required before merge

This PR includes automatic peer discovery via WebSocket signaling. While the API key removal was implemented, there are critical security issues that must be addressed.

---

## Critical Findings

### 1. ‚ùå API Key Still in Git History
**Severity:** CRITICAL
**Status:** INCOMPLETE REMEDIATION

The hardcoded API key placeholder `YOUR_OPENAI_API_KEY_HERE` was removed from the working tree but **remains in git history**:

```bash
git log --all --patch -- scripts/voice_mode.sh | grep "YOUR_OPENAI_API_KEY_HERE"
```

Shows the placeholder still exists in commit history. While this is just a placeholder (not a real key), it demonstrates that **any actual API key committed previously is still in the repository's history**.

**Required Action:**
- If any real OpenAI API key was ever committed, it **must be revoked immediately** at platform.openai.com
- Recommend: `git filter-repo` or BFG Repo-Cleaner to scrub history if real keys were exposed
- Verify with `gitleaks` scan: `gitleaks detect --source=. --verbose`

---

### 2. ‚ùå WebSocket Signaling Server - No Authentication
**Severity:** HIGH
**Status:** VULNERABILITY IDENTIFIED

**File:** `signaling-server.js`

The WebSocket signaling server on port 9000 has **no authentication or authorization**:

```javascript
// Line 26-29: No authentication check
const server = http.createServer((req, res) => {
  res.writeHead(200, { 'Content-Type': 'text/plain' });
  res.end('Chatsubo Signaling Server\n');
});

// Line 36-70: Accepts any connection
wss.on('connection', (ws) => {
  console.log('[Chatsubo Signaling] New WebSocket connection');
  // No authentication challenge
  // No origin validation
  // No rate limiting
});
```

**Attack Vectors:**
1. **Room Flooding:** Attacker can join any room and consume all 10 slots
2. **Peer Impersonation:** Attacker can claim any peer ID (no verification)
3. **DoS via Connection Spam:** Unlimited connections accepted
4. **Room Enumeration:** Attacker can probe for room existence
5. **Traffic Sniffing:** Peer discovery metadata exposed

**Recommended Mitigations:**
1. **Origin Validation:** Whitelist allowed origins
   ```javascript
   wss.on('connection', (ws, req) => {
     const origin = req.headers.origin;
     if (!allowedOrigins.includes(origin)) {
       ws.close(1008, 'Origin not allowed');
       return;
     }
   });
   ```

2. **Rate Limiting:** Limit connections per IP
   ```javascript
   const rateLimits = new Map(); // IP -> { count, resetTime }
   ```

3. **Peer ID Verification:** Cryptographic challenge-response
   ```javascript
   // Require signed peer ID to prevent impersonation
   ```

4. **Connection Limits:** Per-IP connection limits (prevent DoS)

---

### 3. ‚ö†Ô∏è Unencrypted WebSocket (ws://)
**Severity:** MEDIUM
**Status:** INSECURE TRANSPORT IN DEV MODE

**File:** `src/network/SignalingClient.js:37-39`

```javascript
const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const hostname = window.location.hostname;
const wsUrl = `${protocol}//${hostname}:9000/`;
```

In development (http://localhost:5173), this uses **unencrypted ws://** protocol.

**Risk:**
- Peer discovery metadata transmitted in plaintext
- Room IDs, peer IDs, join/leave events visible to network observers
- While PeerJS audio is E2E encrypted, signaling metadata is not

**Required for Production:**
- Enforce `wss://` only (refuse to connect over ws://)
- Implement TLS/SSL certificate for signaling server
- Add to pre-deployment checklist

---

### 4. ‚ö†Ô∏è No Input Validation
**Severity:** MEDIUM
**Status:** XSS/INJECTION RISK

**File:** `signaling-server.js:105-114`

```javascript
function handleJoin(ws, roomId, peerId) {
  if (!roomId || !peerId) {
    ws.send(JSON.stringify({
      type: 'error',
      message: 'Missing roomId or peerId',
    }));
    return;
  }
  // No validation of roomId/peerId format
  // No sanitization of input
}
```

**Attack Vectors:**
- Injection attacks via malicious roomId/peerId (e.g., `../../../etc/passwd`)
- XSS if peer IDs displayed in client UI without sanitization
- Room ID collision attacks

**Recommended Validation:**
```javascript
const ROOM_ID_REGEX = /^[a-zA-Z0-9_-]{1,50}$/;
const PEER_ID_REGEX = /^[a-zA-Z0-9_-]{1,100}$/;

if (!ROOM_ID_REGEX.test(roomId) || !PEER_ID_REGEX.test(peerId)) {
  ws.close(1008, 'Invalid format');
  return;
}
```

---

### 5. ‚ö†Ô∏è Broadcast to All - No Message Filtering
**Severity:** MEDIUM
**Status:** INFORMATION DISCLOSURE

**File:** `signaling-server.js:225-238`

```javascript
function broadcastToRoom(roomId, message, excludeWs) {
  const room = rooms.get(roomId);
  if (!room) return;

  const messageStr = JSON.stringify(message);
  room.forEach((peer) => {
    if (peer.ws !== excludeWs && peer.ws.readyState === 1) {
      peer.ws.send(messageStr); // No message filtering
    }
  });
}
```

**Risk:**
- All peers see join/leave events with full peer IDs
- Potential for metadata correlation attacks
- No privacy controls on who can see what

---

### 6. ‚úÖ Secrets Management - Compliant
**Severity:** N/A
**Status:** PASS

- ‚úÖ API keys removed from working tree
- ‚úÖ .gitignore properly configured (.env, .env.local)
- ‚úÖ No credentials found in source code
- ‚úÖ VaultWarden references removed (appropriate for open-source)

**Note:** While current code is clean, **git history cleanup still required** (see Finding #1).

---

## Recommendations

### Immediate (Before Merge)
1. **Verify no real API keys in history:** Run `gitleaks detect`
2. **Add authentication to signaling server:** Origin validation + rate limiting
3. **Input validation:** Sanitize all roomId/peerId inputs
4. **Document security assumptions:** Add SECURITY.md explaining current threat model

### Short-term (v1.1)
1. **Implement wss:// enforcement** for production
2. **Add cryptographic peer ID verification**
3. **Connection limits per IP address**
4. **Security audit of PeerJS mesh network**

### Long-term (v2.0)
1. **Replace WebSocket signaling with authenticated service**
2. **Implement room access controls (passwords, invite-only)**
3. **Add abuse reporting and moderation tools**
4. **Penetration testing before public deployment**

---

## Pre-Merge Checklist

- [ ] Run `gitleaks detect --source=. --verbose` (no findings)
- [ ] Add origin validation to signaling server
- [ ] Add input validation (roomId, peerId regex)
- [ ] Document security assumptions in README
- [ ] Create GitHub Issue for production security hardening
- [ ] Revoke any real API keys if found in history

---

## Conclusion

This PR demonstrates good progress on peer discovery, but **signaling server security must be addressed before production use**. The lack of authentication/authorization is acceptable for local development but **unacceptable for public deployment**.

**Recommendation:**
- ‚úÖ Approve for **development/testing purposes only**
- ‚ùå Block for **production deployment** until security issues resolved
- üìã Create follow-up security hardening issue

---

**Security Expert:** security-expert agent
**Review Date:** 2025-12-25
**Classification:** PRIVATE
